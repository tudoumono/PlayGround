# 製品範囲・前提（Scope）

* [ ] **配布形態**：静的ホスティング or ローカル配布（BYOK：利用者自身の API キー入力）。
* [ ] **推奨API**：OpenAI **Responses API**（ツール＝File Search / Web Search）、**Vector Stores**、**Files**。([OpenAI Platform][2])
* [ ] **開発SDK**：**Vercel AI-SDK**（`streamText` によるストリーミング、`generateObject` による構造化要約）。([AI SDK][3])
* [ ] **非機能**：CORSに備え**Base URL 切替（ゲートウェイ/プロキシ）**を設定画面で許可。([AI SDK][4])

---

# 0) 既定ルール（合意事項）

* [ ] **Web検索トグル＝既定OFF**（必要時のみON）。Responsesの**Web Search ツール**をON時のみ付与。([OpenAI Platform][5])
* [ ] **添付既定**：画像→**今だけ（Vision）**／文書→**恒久登録（Vector Store）**／音声→**文字起こし→今だけ**。ユーザーが上書き可。([OpenAI Platform][2])
* [ ] **Vector Store 複数選択**は**最大3件**。万一配列サポートの挙動差でエラー時は**先頭1件へ縮退**し通知。([OpenAI Platform][2])
* [ ] **履歴保存＝IndexedDB**（ローカルのみ）＋**JSON エクスポート/インポート**。([MDNウェブドキュメント][6])
* [ ] **送信最適化**：**直近Kターン＋要約（`generateObject`）**で文脈投入。AI-SDKの逐次生成は **`streamText`**。([AI SDK][7])

---

# 1) 画面（G0〜G5）と主要要件

## [G0] ウェルカム/キー設定（BYOK）

* [ ] APIキー入力、**Base URL**（既定 `https://api.openai.com/v1`）／**追加ヘッダ**／Organization・Project。**接続テスト**で `/v1/models` を叩く。([OpenAI Platform][8])
* [ ] 保存ポリシー：キーは「保存しない/一時/永続」から選択。
* [ ] （任意）**暗号化パスフレーズ**を入力 → WebCrypto **AES-GCM** で履歴本文を暗号化保存。([MDNウェブドキュメント][9])
  **AC**：`GET /v1/models` 成功で🟢／401/403/429/ネットワーク/ CORS 失敗を識別し、**ゲートウェイBase URL**切替ガイダンスを出す。([OpenAI Platform][8])

## [G1] ダッシュボード（会話一覧＋Vector Store一覧）

* [ ] 会話一覧（IndexedDB）検索・タグ・更新順、**JSONエクスポート/インポート**。([MDNウェブドキュメント][6])
* [ ] Vector Store 一覧（ID/名前/件数/更新日）。**IDワンクリコピー**。`GET /v1/vector_stores`。([OpenAI Platform][10])
  **AC**：エクスポートJSONを同一PCにインポート→会話が再現。

## [G2] Vector Store 管理

* [ ] 作成/削除/メタ編集、上限・状態表示。`POST/DELETE/GET /v1/vector_stores`。([OpenAI Platform][10])
* [ ] **ファイルバッチ**のステータス（`in_progress/completed/failed`）が見える。`.../file_batches`。([OpenAI Platform][11])
  **AC**：作成→即IDコピー可能／削除→一覧から除去。

## [G3] 取り込み（ファイル→Vector Store）

* [ ] **Files** へアップロード（`purpose=assistants`）→ Vector Store へ **file_batches** で一括登録 → **ポーリング**。([OpenAI Platform][12])
* [ ] PDFの**テキスト層検知**→スキャンなら**OCR（Tesseract.js）**提案。([tesseract.projectnaptha.com][13])
* [ ] **サイズ上限**に応じた警告（参考：**1ファイル最大 512MB** などの実運用目安）。([OpenAI Help Center][14])
  **AC**：進捗バーが `file_counts` で増減し、失敗はリスト化・再試行可能。([OpenAI Platform][11])

## [G4] 検索＆チャット（RAG/マルチモーダル）

* [ ] **モデル選択**（`/v1/models` 結果）、**Web検索トグル（既定OFF）**、**ベクトル検索トグル（既定ON）**、**Vector Store複数選択≤3**。([OpenAI Platform][8])
* [ ] **添付カード**：画像=今だけ/Vision、文書=登録、音声=文字起こし→今だけ／**両方**も可。
* [ ] 送信時：`POST /v1/responses` に

  * `tools`: `[{type:"file_search"}]`（ON時）＋ **Web Search**（ON時）
  * `tool_resources.file_search.vector_store_ids=[...]`
  * `input_text` / `input_image` / `input_audio` を適宜同梱（マルチモーダル）。([OpenAI Platform][2])
* [ ] **出典パネル**：**Vector / Web / 添付** をタブ分離で表示。
  **AC**：トグルON/OFFが送信ボディの `tools` に反映。引用メタに Vector（ファイル・抜粋）と Web（URL・タイトル）が区別表示。([OpenAI Platform][5])

## [G5] 設定（モデル／プロキシ／履歴）

* [ ] **モデル一覧**：`GET /v1/models`（用途フィルタ・検索・直打ち許容）。([OpenAI Platform][15])
* [ ] **プロキシ/ゲートウェイ**：**Base URL/追加ヘッダ**を設定でき、**/v1/models** で接続テスト。AI-SDKの **OpenAI Provider** は `baseURL`/`headers` 指定に対応。([AI SDK][4])
* [ ] 履歴の**JSONエクスポート/インポート**、（任意）**AES-GCM**暗号化ON/OFF。([MDNウェブドキュメント][9])
  **AC**：Base URL を切り替えても一覧取得・送信が成功。

---

# 2) 添付カードUI（抜粋：重要チェック）

* [ ] **推奨ルート**自動表示（画像→今だけ、文書→登録、音声→起こし→今だけ／上書き可）。([OpenAI Platform][2])
* [ ] **ルーティング選択（必須）**：今だけ／恒久登録／両方。
* [ ] **Vector Store 選択**：複数可（最大3）・IDコピー・検索。送信は `vector_store_ids: string[]`。([OpenAI Platform][2])
* [ ] **OCR提案（PDFスキャン検知）**：ON時はOCRして登録。([tesseract.projectnaptha.com][13])
* [ ] **進捗**：Filesアップロード→file_batches登録→**`status`/`file_counts`**で可視化。([OpenAI Platform][12])
* [ ] **制約**：512MB超は分割/要約アップロードを提示。([OpenAI Help Center][14])
* [ ] **縮退**：vector_store_ids 配列でエラー時は先頭1件へ自動縮退＋通知。([OpenAI コミュニティ][16])

---

# 3) 履歴と送信最適化

* [ ] **保存＝IndexedDB**（大容量・非同期・検索向き）。Web Storage は設定等の軽量値に限定。([MDNウェブドキュメント][6])
* [ ] **暗号化（任意）**：WebCrypto **AES-GCM**（鍵導出は PBKDF2 等）で本文を保護。([MDNウェブドキュメント][9])
* [ ] **送信ウィンドウ**：直近Kターン＋**`generateObject`要約**を 1 ブロックとして前置。([AI SDK][7])
* [ ] **描画**：`streamText` で逐次表示。([AI SDK][3])
  **AC**：長尺会話でも応答遅延・コストが安定（トークン上限内に収まる）。

---

# 4) コストと上限の扱い（表示・警告）

* [ ] **File Search**：**ストレージ $0.10/GB/日（最初の1GB無料）**、**ツールコール $2.50/1k**（Responsesのみ）。UI で概算/注意を提示。([OpenAI][17])
* [ ] （参考）**ファイル上限**：一般に**512MB/ファイル**や**5Mトークン/ファイル**等の目安が周知。ヘルプ/クラウド各社のガイドも参照（環境差あり）。([OpenAI Help Center][14])
* [ ] **Web検索**はツールコール課金レンジあり（プレビュー/通常）。必要時のみONを推奨。([OpenAI][17])
  **AC**：取り込み・検索時に**費用の目安**をUIで見せる。

---

# 5) エラーハンドリング／フォールバック

* [ ] **CORS/ネットワーク**：`/v1/models` 失敗で**Base URL 切替**（ゲートウェイ）をガイド。([Cloudflare Docs][18])
* [ ] **ベクトル登録失敗**：再試行、分割/要約、OCR経由などの代替ルートを提示。([OpenAI Platform][11])
* [ ] **複数Vector Store**（稀な挙動差）：送信時に**自動縮退**＋トースト通知。([OpenAI コミュニティ][16])
* [ ] **Web検索ノイズ**：既定OFF、ON時は**出典分離**で可観測化。([OpenAI Platform][5])

---

# 6) セキュリティ/プライバシー

* [ ] **ローカル保存のみ**（既定）。エクスポートは**手動**、暗号化オプション。([MDNウェブドキュメント][6])
* [ ] APIキーは保存しない（またはセッションのみ）。
* [ ] **WebCrypto AES-GCM**の実装（IV/タグの適切な保管・復号手順）。([MDNウェブドキュメント][19])

---

# 7) 受け入れ基準（総合）

* [ ] **すべての画面**で `/v1/models` が成功（直・ゲートウェイ切替双方）。([OpenAI Platform][8])
* [ ] **Vector登録**：Files→file_batches→ポーリング→`completed/failed` がUIで追える。([OpenAI Platform][12])
* [ ] **チャット送信**：`tools` に file_search / web_search がトグル通り入り、`vector_store_ids` が配列で送られる（失敗時は縮退）。([OpenAI Platform][2])
* [ ] **履歴**：IndexedDB から復元／JSONインポートで再現。([MDNウェブドキュメント][20])
* [ ] **要約**：`generateObject` で構造化要約を生成し、長会話でも安定応答。([AI SDK][7])
* [ ] **ストリーミング表示**：`streamText` により途切れなく反映。([AI SDK][3])

---

# 8) 参考リンク（主要一次情報）

* **AI-SDK**：`streamText`／生成テキスト、`generateObject`／構造化出力、Provider/`baseURL` 管理。([AI SDK][3])
* **OpenAI**：Responses API、Web Search ツール、File Search（Vector Stores / file_batches / Files / Models）。([OpenAI Platform][2])
* **IndexedDB**（MDN）／**WebCrypto AES-GCM**（MDN）。([MDNウェブドキュメント][6])
* **OCR（Tesseract.js）**。([tesseract.projectnaptha.com][13])
* **File Search 料金**（公式）。([OpenAI][17])
* **複数 Vector Store の挙動差（コミュニティ報告）**。([OpenAI コミュニティ][16])

---

## 付録A：CSV版（進捗管理用にそのまま表計算へ貼り付け）

```
セクション,項目,必須,既定/条件,確認方法/AC,出典
Scope,Responses+Vector+Files採用,Yes,OpenAI公式,エンドポイント到達性とサンプル実行,:contentReference[oaicite:57]{index=57}
0)既定,Web検索トグル既定OFF,Yes,必要時のみON,送信時toolsにWeb Searchが含まれない(ONで含む),:contentReference[oaicite:58]{index=58}
0)既定,添付の既定ルート,Yes,画像=今だけ/文書=登録/音声=起こし→今だけ,初期提案と上書き反映,:contentReference[oaicite:59]{index=59}
0)既定,Vector Store複数≤3かつ縮退,Yes,>3は不可/失敗→先頭1件,送信時のvector_store_idsとエラーハンドリング,:contentReference[oaicite:60]{index=60}
G0,モデル一覧/接続テスト,Yes,/v1/models,成功🟢/失敗コード別表示,:contentReference[oaicite:61]{index=61}
G0,プロキシ(Base URL)切替,Yes,任意ヘッダ,BaseURL変更後も一覧取得OK,:contentReference[oaicite:62]{index=62}
G0,履歴暗号化(任意),No,AES-GCM,ロック/復号動作,:contentReference[oaicite:63]{index=63}
G1,会話エクスポート/インポート,Yes,JSON,同一PCで再現,:contentReference[oaicite:64]{index=64}
G1,Vector Store一覧表示,Yes,GET /v1/vector_stores,IDコピー/再取得OK,:contentReference[oaicite:65]{index=65}
G2,Vector Store作成/削除,Yes,POST/DELETE,一覧に即反映,:contentReference[oaicite:66]{index=66}
G2,バッチ進捗可視化,Yes,file_batchesポーリング,status/file_counts表示,:contentReference[oaicite:67]{index=67}
G3,Files→登録,Yes,Files→file_batches,アップロード→登録→完了/失敗遷移,:contentReference[oaicite:68]{index=68}
G3,OCR提案(スキャンPDF),No,Tesseract.js,ONでOCR後に登録,:contentReference[oaicite:69]{index=69}
G3,サイズ超過ガード,Yes,~512MB/ファイル目安,警告と分割/要約案内,:contentReference[oaicite:70]{index=70}
G4,トグル/モデル選択,Yes,Web/Vector/モデル,toolsとvector_store_ids反映,:contentReference[oaicite:71]{index=71}
G4,マルチモーダル入力,Yes,input_text/image/audio,適切に同梱,:contentReference[oaicite:72]{index=72}
G4,出典パネル分離,Yes,Vector/Web/添付,引用の区別表示,:contentReference[oaicite:73]{index=73}
G5,Base URL/追加ヘッダ設定,Yes,ゲートウェイ互換,接続テスト成功,:contentReference[oaicite:74]{index=74}
履歴,IndexedDB保存,Yes,ローカル限定,再読込で復元,:contentReference[oaicite:75]{index=75}
履歴,JSONエクスポート/復元,Yes,暗号化時は要パス,復元成功,:contentReference[oaicite:76]{index=76}
送信最適化,直近K+要約,Yes,generateObjectで作成,総トークン管理,:contentReference[oaicite:77]{index=77}
送信最適化,ストリーミング表示,Yes,streamText,潤滑な逐次描画,:contentReference[oaicite:78]{index=78}
コスト,File Search料金表示,Yes,$0.10/GB/日 & $2.50/1k,UIで概算表示,:contentReference[oaicite:79]{index=79}
フォールバック,CORS/接続失敗時,Yes,BaseURL切替案内,テスト→復旧,:contentReference[oaicite:80]{index=80}
フォールバック,vector_store_ids配列誤作動,Yes,自動縮退,トースト通知,:contentReference[oaicite:81]{index=81}
```


[1]: https://ai-sdk.dev/docs/introduction?utm_source=chatgpt.com "AI SDK by Vercel"
[2]: https://platform.openai.com/docs/api-reference/responses?utm_source=chatgpt.com "Responses API reference"
[3]: https://ai-sdk.dev/docs/reference/ai-sdk-core/stream-text?utm_source=chatgpt.com "AI SDK Core: streamText"
[4]: https://ai-sdk.dev/providers/ai-sdk-providers/openai?utm_source=chatgpt.com "OpenAI provider - AI SDK"
[5]: https://platform.openai.com/docs/guides/tools-web-search?api-mode=responses&utm_source=chatgpt.com "Enable web search with Responses API"
[6]: https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API?utm_source=chatgpt.com "IndexedDB API - Web - MDN - Mozilla"
[7]: https://ai-sdk.dev/docs/reference/ai-sdk-core/generate-object?utm_source=chatgpt.com "AI SDK Core: generateObject"
[8]: https://platform.openai.com/docs/api-reference/models?utm_source=chatgpt.com "api-reference/models"
[9]: https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API?utm_source=chatgpt.com "Web Crypto API - MDN"
[10]: https://platform.openai.com/docs/api-reference/vector-stores?utm_source=chatgpt.com "OpenAI API Reference - Vector Stores"
[11]: https://platform.openai.com/docs/api-reference/vector-stores-file-batches?utm_source=chatgpt.com "Vector store file batches"
[12]: https://platform.openai.com/docs/api-reference/files?utm_source=chatgpt.com "OpenAI's Files API reference"
[13]: https://tesseract.projectnaptha.com/?utm_source=chatgpt.com "Tesseract.js | Pure Javascript OCR for 100 Languages!"
[14]: https://help.openai.com/en/articles/8555545-file-uploads-faq?utm_source=chatgpt.com "File Uploads FAQ"
[15]: https://platform.openai.com/docs/api-reference/models/list?utm_source=chatgpt.com "List models API"
[16]: https://community.openai.com/t/bug-or-wrong-documentation-responses-api-vector-store-ids-array-limited-to-one/1165564?utm_source=chatgpt.com "Responses api vector_store_ids array limited to one - ..."
[17]: https://openai.com/api/pricing/?utm_source=chatgpt.com "API Pricing"
[18]: https://developers.cloudflare.com/ai-gateway/integrations/vercel-ai-sdk/?utm_source=chatgpt.com "Vercel AI SDK · Cloudflare AI Gateway docs"
[19]: https://developer.mozilla.org/en-US/docs/Web/API/AesGcmParams?utm_source=chatgpt.com "AesGcmParams - Web APIs | MDN - Mozilla"
[20]: https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Using_IndexedDB?utm_source=chatgpt.com "Using IndexedDB - Web APIs | MDN - Mozilla"



# 1) 画面遷移図（高レベル IA）

```
[G0] ウェルカム/キー設定
   └→ [G1] ダッシュボード（会話一覧＋Vector Store一覧）
          ├→ [G2] Vector Store管理（作成/削除/IDコピー）
          ├→ [G3] 取り込み（ファイル→Files→Vector Storeバッチ）
          ├→ [G4] 検索&チャット（履歴・添付カード・RAG/Web切替）
          └→ [G5] 設定（モデル一覧/プロキシ/暗号化/エクスポート）
```

* **IndexedDB** に履歴と設定を保存（Web Storage は軽量設定のみ）。大容量や検索向きに IndexedDB を選ぶのが標準的です。([MDNウェブドキュメント][2])
* **OpenAI 側 API** は **Files／Vector Stores（バッチ登録・進捗）／Responses（file_search, web_search ツール）**を利用します。([OpenAI Platform][3])

---

# 2) 画面別：実装内容（機能／API／状態／検証）

## [G0] ウェルカム & キー設定（BYOK）

**目的**：ユーザー自身の API キー入力・接続テスト・（任意）暗号化パスフレーズ設定
**UI**：APIキー入力、Base URL（標準 `https://api.openai.com/v1`／ゲートウェイ切替可）、Organization/Project、接続テスト、保存ポリシー（未保存/一時/永続）

* **API/実装**

  * 接続テスト：`GET /v1/models` を叩き、認証・CORS・権限を即判定。([OpenAI Platform][4])
  * 保存先：APIキーは既定で**保存しない**か **sessionStorage**、履歴や設定は **IndexedDB**。([MDNウェブドキュメント][2])
  * （任意）**WebCrypto AES-GCM**で履歴を暗号化保存するためのパスフレーズ入力。([MDNウェブドキュメント][5])
* **検証**：成功時はモデル一覧取得OK／失敗時は 401/403/429 を表示、CORS 失敗はゲートウェイに切替案内。

---

## [G1] ダッシュボード

**目的**：会話の起点。**会話一覧（IndexedDB）**と**Vector Store 一覧（OpenAI）**を俯瞰

* **機能**

  * 会話一覧（検索・タグ・更新順）／新規作成／複製／削除／**JSONエクスポート/インポート**
  * Vector Store 一覧（`id/name/file_counts/updated_at`）表示、**IDワンクリコピー**
* **API**

  * Vector Stores 一覧：`GET /v1/vector_stores`（必要に応じページング）([OpenAI Platform][6])
* **状態**

  * `conversations[]`（IndexedDB）、`vectorStores[]`（メモリ＋再取得ボタン）
* **検証**：エクスポートJSONが他端末で**インポート→再現**できること（同一PC前提・暗号化時はパス要）。

---

## [G2] Vector Store 管理

**目的**：**作成／削除／メタ編集／IDコピー**

* **API**

  * 作成：`POST /v1/vector_stores`、削除：`DELETE /v1/vector_stores/{id}`、詳細：`GET /v1/vector_stores/{id}`。([OpenAI Platform][6])
* **注意**

  * **複数ストア同時利用**：Responses `file_search` には **`vector_store_ids: string[]`** を渡せる想定。ただし一部環境で配列が1件扱いになる報告があるため、**送信時に自動縮退（先頭1件）**のフォールバックを実装。([OpenAI コミュニティ][7])

---

## [G3] 取り込み（アップロード→バッチ登録→進捗）

**目的**：PDF/Doc/TXT 等を **Files → Vector Store** に登録し、**進捗を可視化**

* **API**

  * アップロード：`POST /v1/files`（`purpose=assistants` 必須）([OpenAI Platform][3])
  * バッチ登録：`POST /v1/vector_stores/{id}/file_batches`、ポーリング：`GET /v1/vector_stores/{id}/file_batches/{batch_id}`（`status`/`file_counts`）。([OpenAI Platform][6])
* **UI/状態**

  * **添付カード**（種別推定・「今だけ/恒久/両方」・OCR提案・Vector Store 複数選択≦3）
  * 進捗バー（`in_progress → completed/failed`、失敗リスト再試行）
* **検証**：大容量/多数ファイルで**ステータスと件数**が正しく遷移すること。

---

## [G4] 検索 & チャット（RAG/マルチモーダル）

**目的**：RAG＋Web検索を**トグル**で制御し、**ストリーミング表示**しながら**履歴最適化**で送信量を抑制

* **UI**

  * モデル選択（/v1/models の結果）／**Web検索トグル（既定OFF）**／**ベクトル検索トグル（既定ON）**
  * Vector Store 複数選択（最大3）／**添付カード**（画像=今だけ/Vision、文書=登録、音声=文字起こし→今だけ）
  * 出典パネル（**Vector / Web / 添付** のタブ）
* **API**

  * 送信：`POST /v1/responses`

    * `tools`: `[{type: "file_search"}]`（ON時）と **Web Search ツール**（ON時）を配列に含める。
    * `tool_resources.file_search.vector_store_ids = [選択ID…]`。([OpenAI Platform][8])
  * **テキスト/画像/音声**は **Responses のマルチモーダル入力**（`input_text` / `input_image` / `input_audio`）として同梱。([OpenAI Platform][4])
* **AI-SDK**

  * **`streamText`**で回答をストリーミング描画（ツールコールも多段で処理可）。([AI SDK][1])
  * **`generateObject`**で「要点3行」「FAQ JSON」などの**構造化出力**（UI部品に直結）。([AI SDK][9])
* **検証**

  * Web/Vector トグルのON/OFFが **`tools` 配列**へ正しく反映。
  * **引用表示**に Vector（ファイル名/スニペット）と Web（URL/タイトル）が区別表示される。

---

## [G5] 設定（モデル／プロキシ／履歴）

**目的**：**モデル選択**、**API ベースURL（プロキシ/ゲートウェイ）**、**履歴のエクスポート/インポート**、暗号化

* **API**

  * モデル一覧：`GET /v1/models`（選択→キャッシュ→既定を記憶）。([OpenAI Platform][4])
* **実装**

  * **Base URL** を切替可能（OpenAI 互換のゲートウェイも可）。接続テストは `/v1/models`。
  * 履歴エクスポート/インポート（IndexedDBの会話データを JSON に変換）。
  * **暗号化**：AES-GCM（WebCrypto）で履歴本文を保護（パスフレーズ依存）。([MDNウェブドキュメント][5])
* **検証**：Base URL 切替後もモデル一覧・送信が成功すること。

---

# 3) 履歴の保存＆送信最適化（直近＋要約）

## 保存（クライアントのみ）

* **IndexedDB** に `conversations`／`messages`／`attachments`／`settings` を分離保存。大容量・非同期・検索適性のため IndexedDB を採用。([MDNウェブドキュメント][2])
* **暗号化オプション**：WebCrypto AES-GCM を利用（鍵導出は PBKDF2 等）。([MDNウェブドキュメント][5])

## 送信アルゴリズム（疑似手順）

1. **トークン予算**（例：8k）を決める。
2. 直近から**Kターン**を逆順で積み上げ、予算を超えそうなら停止。
3. それより古い部分は**`generateObject` で短縮要約**を定期生成し、**system か user の “summary”**として 1 ブロックだけ送る。([AI SDK][9])
4. 添付（今だけ）や選択ツール（file_search / web_search）はこのリクエストに同梱。
5. **`streamText`** で描画（中間ツールコールにも追従）。([AI SDK][1])

> これにより、**AI-SDKのデフォルト「全履歴送信」**パターンを避け、**応答速度とコスト**を最適化します。([AI SDK][10])

---

# 4) データモデル（IndexedDB 概略）

* **conversations**：`{ id, title, createdAt, updatedAt, modelId, webSearch:boolean, vectorStoreIds:string[], encrypted:boolean }`
* **messages**：`{ id, conversationId, role, parts:[{type:'text'|'image'|'audio'|'data', value}], createdAt, isSummary?:boolean }`
* **attachments**：`{ id, conversationId, fileId?, vectorStoreId?, url?, ocr:boolean }`
* **settings**：`{ apiBaseUrl, org, project, headers[], historyPolicy, encryptionSalt, ... }`

MDN のガイドに沿ってオブジェクトストアとインデックスを設計（例：`messages` は `conversationId + createdAt` で検索）。([MDNウェブドキュメント][11])

---

# 5) 主要ユースケース別 AC（受入基準）

* **履歴の再現**：再読込後も IndexedDB から会話が復元される。([MDNウェブドキュメント][2])
* **JSONエクスポート/インポート**：同一PCでインポート→画面に会話が再表示。
* **RAG**：`file_search` 有効時に **`vector_store_ids`** が送信され、引用に登録ファイルが現れる。([OpenAI Platform][8])
* **Web検索**：トグルON時のみ Web Search ツールが `tools` に含まれる。([OpenAI Platform][12])
* **取り込み**：`/v1/files` → `/v1/vector_stores/{id}/file_batches` のポーリングで `completed/failed` がUIに反映。([OpenAI Platform][3])
* **ストリーミング**：回答は途中から表示され、最終まで”止まらず”に連結される（`streamText`）。([AI SDK][1])
* **複数ストア**：配列指定で動く／万一エラー時は**先頭1件に縮退**して通知。([OpenAI コミュニティ][7])

---

# 6) 実装メモ（抜粋）

* **チャット描画**：AI-SDK `streamText` を中核に、**中間ツールコールや構造化ストリーミング**は同 SDK のガイド通り。([AI SDK][1])
* **構造化要約**：`generateObject` で `{ bullets: string[] }` など定型スキーマの要約を生成し、古い履歴を圧縮。([AI SDK][9])
* **ファイル登録**：Files API（`purpose=assistants`）→ Vector Store ファイルバッチ → 進捗API。([OpenAI Platform][3])
* **CORS/環境差**：/v1 を直接叩けない場合に備え **Base URL をゲートウェイへ切替**できるようにしておく。
* **セキュリティ**：暗号化は WebCrypto の **AES-GCM** を採用（サンプル多数・ブラウザ実装が安定）。([MDNウェブドキュメント][5])


[1]: https://ai-sdk.dev/docs/reference/ai-sdk-core/stream-text?utm_source=chatgpt.com "AI SDK Core: streamText"
[2]: https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API?utm_source=chatgpt.com "IndexedDB API - Web - MDN - Mozilla"
[3]: https://platform.openai.com/docs/api-reference/files?utm_source=chatgpt.com "OpenAI's Files API reference"
[4]: https://platform.openai.com/docs/api-reference/responses?utm_source=chatgpt.com "Responses API reference"
[5]: https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API?utm_source=chatgpt.com "Web Crypto API - MDN"
[6]: https://platform.openai.com/docs/api-reference/vector-stores-file-batches?utm_source=chatgpt.com "Vector store file batches"
[7]: https://community.openai.com/t/bug-or-wrong-documentation-responses-api-vector-store-ids-array-limited-to-one/1165564?utm_source=chatgpt.com "Responses api vector_store_ids array limited to one - ..."
[8]: https://platform.openai.com/docs/guides/tools-file-search?utm_source=chatgpt.com "File search - OpenAI API"
[9]: https://ai-sdk.dev/docs/reference/ai-sdk-core/generate-object?utm_source=chatgpt.com "AI SDK Core: generateObject"
[10]: https://ai-sdk.dev/docs/ai-sdk-core/generating-text?utm_source=chatgpt.com "AI SDK Core: Generating Text"
[11]: https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Using_IndexedDB?utm_source=chatgpt.com "Using IndexedDB - Web APIs | MDN - Mozilla"
[12]: https://platform.openai.com/docs/guides/tools-web-search?utm_source=chatgpt.com "Web Search Tool"
