# AI-SDK アプリ設計 + 配布思想 — 統合PRD v1.0
更新日: 2025-10-05

> 本ドキュメントは、これまで合意した **アプリ設計（G0–G5 画面/機能）** と **配布思想（Distribution Philosophy）** を統合したものです。配布は **静的アセット（ZIP）＋BYOK** を基本とし、サーバレス志向で **OpenAI Responses API + File Search（Vector Stores）+ Web Search** を利用します。

---

## 1) 配布思想（Distribution Philosophy）

### 1.1 目的と前提
- **インストール不要／EXE不要**。配布は **ビルド済みの静的アセット**（`index.html` + バンドル済みJS/CSS/アセット）とし、ユーザーは解凍→`index.html`→**自分の OpenAI API キー（BYOK）** を入力して利用します。
- **TSX/React の場合**も同様。**事前ビルド（例: Vite）**で生成した `dist/` を配布対象にします（ブラウザは `.tsx` を直接実行しない）。

### 1.2 セキュリティ基本方針
1) **APIキーは配布しない（BYOK）**。キーはユーザーが入力・保持。  
2) **データはローカル保存（IndexedDB）** を既定。必要に応じ **WebCrypto AES‑GCM** で暗号化（パスフレーズはユーザー管理）。  
3) **CORS/ネットワーク失敗**に備え、**Base URL（プロキシ/ゲートウェイ）切替**を設定画面で許可。

### 1.3 アーキテクチャの原則
- **推論**：AI-SDK `streamText` によるストリーミングUI。
- **RAG**：OpenAI **Responses API** に **File Search（Vector Stores）** をツールとして指定し、`tool_resources.file_search.vector_store_ids` で対象ストアを渡す。
- **Web検索**：既定OFF。必要時に **Web Search ツール**をONし、出典タブで Vector/Web/添付を分離表示。
- **複数Vector Store**：最大3件を選択可能。環境差で配列が1件扱いになる場合に備え、**送信時は自動で先頭1件に縮退**して通知。

### 1.4 データの扱い
- **履歴**：IndexedDBに保存（会話・設定・添付参照）。**JSONエクスポート/インポート**（任意で暗号化）。
- **送信最適化**：毎回全履歴を送らず、**直近Kターン + 構造化要約（`generateObject`）** を前置して送る。

### 1.5 既定スイッチ
- **Web検索：OFF**（ノイズ抑制・必要時のみON）。
- **ベクトル検索：ON**（確定情報を優先）。
- **添付既定**：画像=今だけ（Vision）／文書=恒久登録／音声=文字起こし→今だけ。

---

## 2) 製品範囲・前提（Scope）
- **配布形態**：静的ホスティング or ローカル配布（BYOK）。
- **主要API**：OpenAI **Responses / File Search（Vector Stores）/ Files / Models / Web Search ツール**。
- **開発SDK**：**Vercel AI‑SDK**（`streamText`, `generateObject`）。
- **非機能**：プロキシ/ゲートウェイ切替、CORS対策、ローカル保存、暗号化（任意）。

---

## 3) 画面遷移（IA）
```
[G0] ウェルカム/キー設定
   └→ [G1] ダッシュボード（会話一覧＋Vector Store一覧）
          ├→ [G2] Vector Store管理（作成/削除/IDコピー）
          ├→ [G3] 取り込み（Files→Vector Storeバッチ/進捗）
          ├→ [G4] 検索&チャット（履歴・添付・RAG/Web切替）
          └→ [G5] 設定（モデル一覧/プロキシ/暗号化/エクスポート）
```

---

## 4) 画面別 要件

### [G0] ウェルカム/キー設定（BYOK）
- APIキー入力、**Base URL/追加ヘッダ**、Organization/Project。  
- **接続テスト**：`GET /v1/models`（成功🟢／401/403/429/CORS判定）。  
- 保存ポリシー：キーは保存しない／セッション／永続から選択。  
- （任意）**暗号化パスフレーズ** → 履歴を AES‑GCM で暗号化保存。

### [G1] ダッシュボード
- 会話一覧（検索・タグ・更新順）、**JSONエクスポート/インポート**。  
- Vector Store 一覧（ID/名前/件数/更新日）・**IDコピー**・再取得。

### [G2] Vector Store 管理
- 作成/削除/メタ編集、状態表示。  
- **file_batches** の `status`/`file_counts` を把握。

### [G3] 取り込み（アップロード→バッチ登録→進捗）
- `POST /v1/files (purpose=assistants)` → `POST /v1/vector_stores/{{id}}/file_batches` → `GET .../file_batches/{{batch_id}}` でポーリング。  
- PDFスキャン検知→**OCR（Tesseract.js）**提案。  
- サイズ上限（目安: 512MB/ファイル）でガード。

### [G4] 検索&チャット（RAG/マルチモーダル）
- **モデル選択**（`/v1/models`）、**Web検索トグル（OFF）**、**ベクトル検索トグル（ON）**、**Vector Store≤3** 選択。  
- **添付カード**：画像=今だけ/Vision、文書=登録、音声=文字起こし→今だけ／両方。  
- 送信: `POST /v1/responses`  
  - `tools`: `file_search`（ON時）＋ `web_search`（ON時）  
  - `tool_resources.file_search.vector_store_ids=[...]`  
  - `input_text` / `input_image` / `input_audio` を同梱  
- **出典パネル**：Vector / Web / 添付 をタブ分離表示。

### [G5] 設定（モデル／プロキシ／履歴）
- **モデル一覧**：`/v1/models`（フィルタ・検索・直打ち）。  
- **プロキシ/ゲートウェイ**：Base URL/追加ヘッダ設定＋接続テスト。  
- 履歴の **JSONエクスポート/インポート**、暗号化ON/OFF。

---

## 5) 添付カード UI（要点）
- **推奨ルート**自動提示（画像=今だけ／文書=登録／音声=起こし→今だけ）。  
- **ルーティング選択（必須）**：今だけ／恒久／両方。  
- **Vector Store 選択**：複数（最大3）・IDコピー・検索。  
- **OCR提案**（スキャンPDF検知時）。  
- **進捗可視化**：Files→file_batches の `status/file_counts`。  
- **縮退**：`vector_store_ids` 配列でエラー時は **先頭1件** へフォールバック＋通知。

---

## 6) 履歴＆送信最適化
- **保存**：IndexedDB（`conversations/messages/attachments/settings`）に分離保存。  
- **暗号化**：WebCrypto AES‑GCM（鍵導出は PBKDF2 等）。  
- **送信**：直近Kターンを優先し、古い履歴は `generateObject` で短縮要約を1ブロックとして前置。  
- **描画**：`streamText` によるストリーミング。

---

## 7) 受け入れ基準（抜粋）
- `/v1/models` が直・ゲートウェイ双方で成功（接続テスト）。  
- Files→file_batches→ポーリングで `completed/failed` がUIに反映。  
- 送信ボディの `tools`/`vector_store_ids` がトグルと選択に一致（失敗時は縮退）。  
- IndexedDB から履歴復元／JSONインポートで再現。  
- 長会話でもトークン上限内（直近K+要約）で安定応答。

---

## 8) 運用・コスト
- **File Search** ストレージ課金＆ツールコール課金の目安をUIに掲示。  
- Web検索は必要時のみON（ノイズ抑制・出典確認の徹底）。

---

## 9) 参考リンク（一次情報）
- **OpenAI**：Responses / File Search（Vector Stores & file_batches）/ Files / Models / Web Search ツール  
- **AI‑SDK**：`streamText`, `generateObject`  
- **MDN**：IndexedDB / WebCrypto AES‑GCM  
- **Tesseract.js**：ブラウザOCR

（補足: 詳細URLは運用READMEに掲載）

---

## 10) FAQ
**Q. TSX のまま配れますか？** → いいえ。**事前ビルド**して静的アセットを配布してください。  
**Q. EXE は作らない方針？** → はい。**静的アセット＋BYOK** を基本とし、配布・更新・セキュリティを簡潔化します。



# 1) 画面遷移図（高レベル IA）

```
[G0] ウェルカム/キー設定
   └→ [G1] ダッシュボード（会話一覧＋Vector Store一覧）
          ├→ [G2] Vector Store管理（作成/削除/IDコピー）
          ├→ [G3] 取り込み（ファイル→Files→Vector Storeバッチ）
          ├→ [G4] 検索&チャット（履歴・添付カード・RAG/Web切替）
          └→ [G5] 設定（モデル一覧/プロキシ/暗号化/エクスポート）
```

* **IndexedDB** に履歴と設定を保存（Web Storage は軽量設定のみ）。大容量や検索向きに IndexedDB を選ぶのが標準的です。([MDNウェブドキュメント][2])
* **OpenAI 側 API** は **Files／Vector Stores（バッチ登録・進捗）／Responses（file_search, web_search ツール）**を利用します。([OpenAI Platform][3])

---

# 2) 画面別：実装内容（機能／API／状態／検証）

## [G0] ウェルカム & キー設定（BYOK）

**目的**：ユーザー自身の API キー入力・接続テスト・（任意）暗号化パスフレーズ設定
**UI**：APIキー入力、Base URL（標準 `https://api.openai.com/v1`／ゲートウェイ切替可）、Organization/Project、接続テスト、保存ポリシー（未保存/一時/永続）

* **API/実装**

  * 接続テスト：`GET /v1/models` を叩き、認証・CORS・権限を即判定。([OpenAI Platform][4])
  * 保存先：APIキーは既定で**保存しない**か **sessionStorage**、履歴や設定は **IndexedDB**。([MDNウェブドキュメント][2])
  * （任意）**WebCrypto AES-GCM**で履歴を暗号化保存するためのパスフレーズ入力。([MDNウェブドキュメント][5])
* **検証**：成功時はモデル一覧取得OK／失敗時は 401/403/429 を表示、CORS 失敗はゲートウェイに切替案内。

---

## [G1] ダッシュボード

**目的**：会話の起点。**会話一覧（IndexedDB）**と**Vector Store 一覧（OpenAI）**を俯瞰

* **機能**

  * 会話一覧（検索・タグ・更新順）／新規作成／複製／削除／**JSONエクスポート/インポート**
  * Vector Store 一覧（`id/name/file_counts/updated_at`）表示、**IDワンクリコピー**
* **API**

  * Vector Stores 一覧：`GET /v1/vector_stores`（必要に応じページング）([OpenAI Platform][6])
* **状態**

  * `conversations[]`（IndexedDB）、`vectorStores[]`（メモリ＋再取得ボタン）
* **検証**：エクスポートJSONが他端末で**インポート→再現**できること（同一PC前提・暗号化時はパス要）。

---

## [G2] Vector Store 管理

**目的**：**作成／削除／メタ編集／IDコピー**

* **API**

  * 作成：`POST /v1/vector_stores`、削除：`DELETE /v1/vector_stores/{id}`、詳細：`GET /v1/vector_stores/{id}`。([OpenAI Platform][6])
* **注意**

  * **複数ストア同時利用**：Responses `file_search` には **`vector_store_ids: string[]`** を渡せる想定。ただし一部環境で配列が1件扱いになる報告があるため、**送信時に自動縮退（先頭1件）**のフォールバックを実装。([OpenAI コミュニティ][7])

---

## [G3] 取り込み（アップロード→バッチ登録→進捗）

**目的**：PDF/Doc/TXT 等を **Files → Vector Store** に登録し、**進捗を可視化**

* **API**

  * アップロード：`POST /v1/files`（`purpose=assistants` 必須）([OpenAI Platform][3])
  * バッチ登録：`POST /v1/vector_stores/{id}/file_batches`、ポーリング：`GET /v1/vector_stores/{id}/file_batches/{batch_id}`（`status`/`file_counts`）。([OpenAI Platform][6])
* **UI/状態**

  * **添付カード**（種別推定・「今だけ/恒久/両方」・OCR提案・Vector Store 複数選択≦3）
  * 進捗バー（`in_progress → completed/failed`、失敗リスト再試行）
* **検証**：大容量/多数ファイルで**ステータスと件数**が正しく遷移すること。

---

## [G4] 検索 & チャット（RAG/マルチモーダル）

**目的**：RAG＋Web検索を**トグル**で制御し、**ストリーミング表示**しながら**履歴最適化**で送信量を抑制

* **UI**

  * モデル選択（/v1/models の結果）／**Web検索トグル（既定OFF）**／**ベクトル検索トグル（既定ON）**
  * Vector Store 複数選択（最大3）／**添付カード**（画像=今だけ/Vision、文書=登録、音声=文字起こし→今だけ）
  * 出典パネル（**Vector / Web / 添付** のタブ）
* **API**

  * 送信：`POST /v1/responses`

    * `tools`: `[{type: "file_search"}]`（ON時）と **Web Search ツール**（ON時）を配列に含める。
    * `tool_resources.file_search.vector_store_ids = [選択ID…]`。([OpenAI Platform][8])
  * **テキスト/画像/音声**は **Responses のマルチモーダル入力**（`input_text` / `input_image` / `input_audio`）として同梱。([OpenAI Platform][4])
* **AI-SDK**

  * **`streamText`**で回答をストリーミング描画（ツールコールも多段で処理可）。([AI SDK][1])
  * **`generateObject`**で「要点3行」「FAQ JSON」などの**構造化出力**（UI部品に直結）。([AI SDK][9])
* **検証**

  * Web/Vector トグルのON/OFFが **`tools` 配列**へ正しく反映。
  * **引用表示**に Vector（ファイル名/スニペット）と Web（URL/タイトル）が区別表示される。

---

## [G5] 設定（モデル／プロキシ／履歴）

**目的**：**モデル選択**、**API ベースURL（プロキシ/ゲートウェイ）**、**履歴のエクスポート/インポート**、暗号化

* **API**

  * モデル一覧：`GET /v1/models`（選択→キャッシュ→既定を記憶）。([OpenAI Platform][4])
* **実装**

  * **Base URL** を切替可能（OpenAI 互換のゲートウェイも可）。接続テストは `/v1/models`。
  * 履歴エクスポート/インポート（IndexedDBの会話データを JSON に変換）。
  * **暗号化**：AES-GCM（WebCrypto）で履歴本文を保護（パスフレーズ依存）。([MDNウェブドキュメント][5])
* **検証**：Base URL 切替後もモデル一覧・送信が成功すること。

---

# 3) 履歴の保存＆送信最適化（直近＋要約）

## 保存（クライアントのみ）

* **IndexedDB** に `conversations`／`messages`／`attachments`／`settings` を分離保存。大容量・非同期・検索適性のため IndexedDB を採用。([MDNウェブドキュメント][2])
* **暗号化オプション**：WebCrypto AES-GCM を利用（鍵導出は PBKDF2 等）。([MDNウェブドキュメント][5])

## 送信アルゴリズム（疑似手順）

1. **トークン予算**（例：8k）を決める。
2. 直近から**Kターン**を逆順で積み上げ、予算を超えそうなら停止。
3. それより古い部分は**`generateObject` で短縮要約**を定期生成し、**system か user の “summary”**として 1 ブロックだけ送る。([AI SDK][9])
4. 添付（今だけ）や選択ツール（file_search / web_search）はこのリクエストに同梱。
5. **`streamText`** で描画（中間ツールコールにも追従）。([AI SDK][1])

> これにより、**AI-SDKのデフォルト「全履歴送信」**パターンを避け、**応答速度とコスト**を最適化します。([AI SDK][10])

---

# 4) データモデル（IndexedDB 概略）

* **conversations**：`{ id, title, createdAt, updatedAt, modelId, webSearch:boolean, vectorStoreIds:string[], encrypted:boolean }`
* **messages**：`{ id, conversationId, role, parts:[{type:'text'|'image'|'audio'|'data', value}], createdAt, isSummary?:boolean }`
* **attachments**：`{ id, conversationId, fileId?, vectorStoreId?, url?, ocr:boolean }`
* **settings**：`{ apiBaseUrl, org, project, headers[], historyPolicy, encryptionSalt, ... }`

MDN のガイドに沿ってオブジェクトストアとインデックスを設計（例：`messages` は `conversationId + createdAt` で検索）。([MDNウェブドキュメント][11])

---

# 5) 主要ユースケース別 AC（受入基準）

* **履歴の再現**：再読込後も IndexedDB から会話が復元される。([MDNウェブドキュメント][2])
* **JSONエクスポート/インポート**：同一PCでインポート→画面に会話が再表示。
* **RAG**：`file_search` 有効時に **`vector_store_ids`** が送信され、引用に登録ファイルが現れる。([OpenAI Platform][8])
* **Web検索**：トグルON時のみ Web Search ツールが `tools` に含まれる。([OpenAI Platform][12])
* **取り込み**：`/v1/files` → `/v1/vector_stores/{id}/file_batches` のポーリングで `completed/failed` がUIに反映。([OpenAI Platform][3])
* **ストリーミング**：回答は途中から表示され、最終まで”止まらず”に連結される（`streamText`）。([AI SDK][1])
* **複数ストア**：配列指定で動く／万一エラー時は**先頭1件に縮退**して通知。([OpenAI コミュニティ][7])

---

# 6) 実装メモ（抜粋）

* **チャット描画**：AI-SDK `streamText` を中核に、**中間ツールコールや構造化ストリーミング**は同 SDK のガイド通り。([AI SDK][1])
* **構造化要約**：`generateObject` で `{ bullets: string[] }` など定型スキーマの要約を生成し、古い履歴を圧縮。([AI SDK][9])
* **ファイル登録**：Files API（`purpose=assistants`）→ Vector Store ファイルバッチ → 進捗API。([OpenAI Platform][3])
* **CORS/環境差**：/v1 を直接叩けない場合に備え **Base URL をゲートウェイへ切替**できるようにしておく。
* **セキュリティ**：暗号化は WebCrypto の **AES-GCM** を採用（サンプル多数・ブラウザ実装が安定）。([MDNウェブドキュメント][5])


[1]: https://ai-sdk.dev/docs/reference/ai-sdk-core/stream-text?utm_source=chatgpt.com "AI SDK Core: streamText"
[2]: https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API?utm_source=chatgpt.com "IndexedDB API - Web - MDN - Mozilla"
[3]: https://platform.openai.com/docs/api-reference/files?utm_source=chatgpt.com "OpenAI's Files API reference"
[4]: https://platform.openai.com/docs/api-reference/responses?utm_source=chatgpt.com "Responses API reference"
[5]: https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API?utm_source=chatgpt.com "Web Crypto API - MDN"
[6]: https://platform.openai.com/docs/api-reference/vector-stores-file-batches?utm_source=chatgpt.com "Vector store file batches"
[7]: https://community.openai.com/t/bug-or-wrong-documentation-responses-api-vector-store-ids-array-limited-to-one/1165564?utm_source=chatgpt.com "Responses api vector_store_ids array limited to one - ..."
[8]: https://platform.openai.com/docs/guides/tools-file-search?utm_source=chatgpt.com "File search - OpenAI API"
[9]: https://ai-sdk.dev/docs/reference/ai-sdk-core/generate-object?utm_source=chatgpt.com "AI SDK Core: generateObject"
[10]: https://ai-sdk.dev/docs/ai-sdk-core/generating-text?utm_source=chatgpt.com "AI SDK Core: Generating Text"
[11]: https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Using_IndexedDB?utm_source=chatgpt.com "Using IndexedDB - Web APIs | MDN - Mozilla"
[12]: https://platform.openai.com/docs/guides/tools-web-search?utm_source=chatgpt.com "Web Search Tool"
